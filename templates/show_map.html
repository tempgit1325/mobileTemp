<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <title>show_map</title>
</head>
<body>
<a href="{{ url_for('show_views.logout') }}">logout</a><br>
<p>map</p>
<button id="enableNotif">Włącz powiadomienia</button>

<a href="https://www.google.com/maps/dir/{{shipment.pickup_lat}},{{shipment.pickup_lng}}/{{ shipment.delivery_lat}},{{ shipment.delivery_lng}}">GoogleMaps</a><br>

<div id="map"
    data-pickup-lat="{{ shipment.pickup_lat or 0 }}" 
    data-pickup-lng="{{ shipment.pickup_lng or 0 }}"
    data-delivery-lat="{{ shipment.delivery_lat or 0 }}" 
    data-delivery-lng="{{ shipment.delivery_lng or 0 }}" 
    style="height: 500px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    var mapDiv = document.getElementById('map');

    var pickup = [
        parseFloat(mapDiv.dataset.pickupLat),
        parseFloat(mapDiv.dataset.pickupLng)
    ];

    var delivery = [
        parseFloat(mapDiv.dataset.deliveryLat),
        parseFloat(mapDiv.dataset.deliveryLng)
    ];

    var map = L.map('map').setView(pickup, 13);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    window.routing = L.Routing.control({
        waypoints: [
            L.latLng(pickup),
            L.latLng(delivery)
        ],
        createMarker: function(i, waypoint, n){
            if (i === 0) {
                return L.marker(waypoint.latLng).bindPopup("Pickup location");
            } else if (i === 1) {
                return L.marker(waypoint.latLng).bindPopup("Delivery location");
            }
            return null;
        }
    }).addTo(map);

    window.routing.getPlan().on('waypointschanged', function(e) {
        let wps = e.waypoints;
        delivery[0] = wps[1].latLng.lat;
        delivery[1] = wps[1].latLng.lng;

        console.log("Nowe delivery:", delivery);
    });

    map.fitBounds([pickup, delivery]);


    // ============================
    //     FUNKCJA DISTANCE
    // ============================
    function distanceKm(lat1, lon1, lat2, lon2) {
        var R = 6371; 
        var dLat = (lat2 - lat1) * Math.PI / 180;
        var dLon = (lon2 - lon1) * Math.PI / 180;

        var a = 
            0.5 - Math.cos(dLat)/2 +
            Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
            (1 - Math.cos(dLon)) / 2;

        return R * 2 * Math.asin(Math.sqrt(a));
    }

const GEOFENCE_RADIUS_KM = 0.25; 
let notified = false;

// Funkcja distanceKm bez zmian
function distanceKm(lat1, lon1, lat2, lon2) {
    var R = 6371; 
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;

    var a = 
        0.5 - Math.cos(dLat)/2 +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        (1 - Math.cos(dLon)) / 2;

    return R * 2 * Math.asin(Math.sqrt(a));
}

// PROŚBA O POWIADOMIENIA
if (Notification.permission !== "granted") {
    Notification.requestPermission();
}

// GEOLACJA — watchPosition działa dynamicznie
navigator.geolocation.watchPosition(
    pos => {
        let userLat = pos.coords.latitude;
        let userLng = pos.coords.longitude;

        let dist = distanceKm(userLat, userLng, delivery[0], delivery[1]);
        console.log("Dystans do celu:", dist, "km");

        if (dist <= GEOFENCE_RADIUS_KM && !notified) {
            notified = true;

            new Notification("Jesteś blisko!", {
                body: "Pozostało mniej niż 250 metrów do miejsca dostawy.",
            });

            alert("Jesteś mniej niż 250 m od celu!");
        }
    },
    error => {
        console.error("Geolokalizacja błąd:", error);
        if (error.code === 1) alert("Zezwól na dostęp do lokalizacji.");
        if (error.code === 2) alert("Nie można uzyskać lokalizacji.");
        if (error.code === 3) alert("Przekroczono czas oczekiwania.");
    },
    { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 }
    );

</script>



</body>
</html>
